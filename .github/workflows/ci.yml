name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [11, 17]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin

      - name: Download JUnit
        run: |
          mkdir -p Gvisual/lib/test
          curl -sL -o Gvisual/lib/test/junit-4.13.2.jar \
            https://repo1.maven.org/maven2/junit/junit/4.13.2/junit-4.13.2.jar
          curl -sL -o Gvisual/lib/test/hamcrest-core-1.3.jar \
            https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar

      - name: Compile source
        working-directory: Gvisual
        run: |
          mkdir -p build/classes
          find src -name '*.java' > sources.txt
          javac -source 8 -target 8 \
            -cp "$(find lib -name '*.jar' -not -path 'lib/test/*' | tr '\n' ':')" \
            -d build/classes \
            @sources.txt

      - name: Compile tests
        working-directory: Gvisual
        run: |
          mkdir -p build/test/classes
          find test -name '*.java' > test-sources.txt
          javac -source 8 -target 8 \
            -cp "build/classes:$(find lib -name '*.jar' | tr '\n' ':')" \
            -d build/test/classes \
            @test-sources.txt

      - name: Run tests
        working-directory: Gvisual
        run: |
          java -cp "build/classes:build/test/classes:$(find lib -name '*.jar' | tr '\n' ':')" \
            org.junit.runner.JUnitCore \
            app.UtilMethodsTest \
            gvisual.EdgeTest \
            gvisual.GraphStatsTest \
            gvisual.ShortestPathFinderTest \
            gvisual.GraphMLExporterTest \
            gvisual.CommunityDetectorTest \
            gvisual.NodeCentralityAnalyzerTest
